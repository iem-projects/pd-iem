#!/usr/bin/make
# -*- mode: Makefile -*-
all: clean depends build
.PHONY: all depends build install clean

RECIPES=iemmatrix iem_tab
TARGETOS=osx
export MACOSX_DEPLOYMENT_TARGET=$(OSXVERSION)

TARGETS=$(RECIPES:=.$(TARGETOS))

DESTDIR=/tmp/pd-iem
PDINCLUDE=/usr/include/pd

base_path=$(abspath $(lastword $(MAKEFILE_LIST))/../..)

recipe_path=$(base_path)/recipes
BUILDDIR=$(base_path)/build


%.recursive:
	for i in $(TARGETS); do \
		test -e $(recipe_path)/$$i && \
		mkdir -p $(BUILDDIR)/$$i && \
		make -C $(BUILDDIR)/$$i -f $(recipe_path)/$$i DESTDIR=$(DESTDIR)/ $(@:.recursive=); \
	done
%.posthook:
	@echo "$(@:.post=) DONE"
depends.posthook:
	find $(BUILDDIR) -name "*.la" -exec rm -v \{\} \;
install.posthook:
	find $(DESTDIR) -name "*.la" -exec rm -v \{\} \;
	cd $(dir $(DESTDIR)) && zip -r pd-iem_${TRAVIS_TAG}_$(TARGETOS).zip $(notdir $(DESTDIR))

depends build install clean: % : %.recursive %.posthook
