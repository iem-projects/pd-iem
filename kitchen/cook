#!/usr/bin/make
# -*- mode: Makefile -*-
all: clean depends build
.PHONY: all depends build install clean


RECIPES=iemlib comport iemmatrix iem_ambi iem_tab
RECIPES+=bsaylor list-abs mrpeach-net mrpeach-osc pduino windowing
#RECIPES+=iemnet
RECIPES+=zexy

TARGETOS=osx
export MACOSX_DEPLOYMENT_TARGET=10.5

TARGETS=$(RECIPES:=.$(TARGETOS))

DESTDIR=/tmp/pd-iem
PDINCLUDE=/usr/include/pd

base_path=$(abspath $(lastword $(MAKEFILE_LIST))/../..)

recipe_path=$(base_path)/recipes
BUILDDIR=$(base_path)/build


%.recursive:
	for i in $(TARGETS); do \
		test -e $(recipe_path)/$$i && \
		mkdir -p $(BUILDDIR)/$$i && \
		make -C $(BUILDDIR)/$$i -f $(recipe_path)/$$i DESTDIR=$(DESTDIR)/ $(@:.recursive=); \
	done
%.posthook:
	@echo "$(@:.post=) DONE"
depends.posthook:
	find $(BUILDDIR) -name "*.la" -exec rm -v \{\} \;
install.posthook:
	find $(DESTDIR) -name "*.la" -exec rm -v \{\} \;
	find $(DESTDIR) -name "*.dll.a" -delete
	find $(BUILDDIR)/pd -iname "*.dll" -delete
	$(base_path)/kitchen/pasty-$(TARGETOS).sh $(DESTDIR)
	cd $(dir $(DESTDIR)) && zip -r pd-iem_${TRAVIS_TAG}_$(TARGETOS).zip $(notdir $(DESTDIR))

depends build install clean: % : %.recursive %.posthook
